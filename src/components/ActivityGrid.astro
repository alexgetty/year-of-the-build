---
/**
 * ActivityGrid — GitHub contribution calendar
 * Displays a grid of contribution squares with CSS-only hover tooltips
 * Data fetched at build time via GitHub GraphQL API
 *
 * Uses container queries to show 4/2/1 quarters based on available width.
 * Weeks are grouped into quarters for responsive hiding.
 */
import {
  fetchGitHubContributions,
  getContributionLevel,
  formatContributionDate,
  type ContributionDay,
} from '../lib/github';

interface Props {
  username: string;
}

const { username } = Astro.props;

// Fetch contribution data at build time
const data = await fetchGitHubContributions(username);
const weeks = data?.calendar.weeks ?? [];
const totalWeeks = weeks.length;

// Process days with levels
type DayWithLevel = ContributionDay & { level: 0 | 1 | 2 | 3 | 4 };

const allWeeks: DayWithLevel[][] = weeks.map((week) =>
  week.contributionDays.map((day) => ({
    ...day,
    level: getContributionLevel(day.contributionCount),
  }))
);

// Split into 4 quarters (~13 weeks each)
const weeksPerQuarter = Math.ceil(totalWeeks / 4);
const quarters = [
  allWeeks.slice(0, weeksPerQuarter),
  allWeeks.slice(weeksPerQuarter, weeksPerQuarter * 2),
  allWeeks.slice(weeksPerQuarter * 2, weeksPerQuarter * 3),
  allWeeks.slice(weeksPerQuarter * 3),
];

// Tooltip positioning - left edge for first weeks, right edge for last weeks
function getTooltipPosition(weekIndexInQuarter: number, quarterIndex: number, weeksInQuarter: number): 'left' | 'center' | 'right' {
  const isFirstQuarter = quarterIndex === 0;
  const isLastQuarter = quarterIndex === 3;
  const isNearStart = weekIndexInQuarter < 3;
  const isNearEnd = weekIndexInQuarter >= weeksInQuarter - 3;

  if (isFirstQuarter && isNearStart) return 'left';
  if (isLastQuarter && isNearEnd) return 'right';
  return 'center';
}
---

<div class="activity-container">
  <div class="activity-grid">
    {quarters.map((quarter, qIndex) => (
      <div class="quarter" data-quarter={qIndex + 1}>
        {quarter.map((week, weekIndex) => (
          <div class="week">
            {week.map((day) => (
              <div
                class="day"
                data-level={day.level}
                data-tooltip-pos={getTooltipPosition(weekIndex, qIndex, quarter.length)}
              >
                <span class="tooltip">
                  {day.contributionCount === 0
                    ? 'No contributions'
                    : day.contributionCount === 1
                      ? '1 contribution'
                      : `${day.contributionCount} contributions`}
                  <br />
                  <span class="tooltip-date">{formatContributionDate(day.date)}</span>
                </span>
              </div>
            ))}
          </div>
        ))}
      </div>
    ))}
  </div>
</div>

<style>
  .activity-container {
    container-type: inline-size;
    background: var(--p-ink-50);
    border: 1px solid var(--p-ink-200);
    padding: 1px;
    overflow: visible;
    max-width: 100%;
  }

  .activity-grid {
    display: flex;
    gap: 1px;
    aspect-ratio: 53 / 7;
  }

  .quarter {
    display: flex;
    gap: 1px;
    flex: 1;
    min-width: 0;
  }

  .week {
    display: flex;
    flex-direction: column;
    gap: 1px;
    flex: 1;
    min-width: 0;
  }

  .day {
    flex: 1;
    border-radius: 1px;
    position: relative;
  }

  /* Contribution levels — Forest gradient */
  .day[data-level='0'] {
    background-color: var(--p-ink-200);
  }

  .day[data-level='1'] {
    background-color: var(--p-forest-200);
  }

  .day[data-level='2'] {
    background-color: var(--p-forest-400);
  }

  .day[data-level='3'] {
    background-color: var(--p-forest-600);
  }

  .day[data-level='4'] {
    background-color: var(--p-forest-800);
  }

  /* =============================================================================
     Container Queries — Show 4/2/1 quarters based on container width
     ============================================================================= */

  /* Medium container: 6 months (hide Q1 & Q2, show Q3 & Q4) */
  @container (max-width: 450px) {
    .activity-grid {
      aspect-ratio: 26 / 7;
    }

    .quarter[data-quarter='1'],
    .quarter[data-quarter='2'] {
      display: none;
    }
  }

  /* Small container: 3 months (hide Q1, Q2, Q3, show only Q4) */
  @container (max-width: 220px) {
    .activity-grid {
      aspect-ratio: 13 / 7;
    }

    .quarter[data-quarter='1'],
    .quarter[data-quarter='2'],
    .quarter[data-quarter='3'] {
      display: none;
    }
  }

  /* =============================================================================
     Tooltip Styles
     ============================================================================= */

  .tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    background: var(--p-ink-950);
    color: var(--p-ink-50);
    font-size: var(--t-font-size-xs);
    line-height: 1.4;
    padding: 6px 10px;
    border-radius: var(--t-radius-md);
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
    pointer-events: none;
    z-index: 100;
    text-align: center;
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    border: 5px solid transparent;
    border-top-color: var(--p-ink-950);
  }

  /* Center-aligned tooltip (default) */
  .day[data-tooltip-pos='center'] .tooltip {
    left: 50%;
    transform: translateX(-50%);
  }

  .day[data-tooltip-pos='center'] .tooltip::after {
    left: 50%;
    transform: translateX(-50%);
  }

  /* Left-aligned tooltip (for left edge) */
  .day[data-tooltip-pos='left'] .tooltip {
    left: 0;
    transform: none;
  }

  .day[data-tooltip-pos='left'] .tooltip::after {
    left: 6px;
    transform: none;
  }

  /* Right-aligned tooltip (for right edge) */
  .day[data-tooltip-pos='right'] .tooltip {
    right: 0;
    left: auto;
    transform: none;
  }

  .day[data-tooltip-pos='right'] .tooltip::after {
    right: 6px;
    left: auto;
    transform: none;
  }

  .tooltip-date {
    color: var(--p-ink-400);
  }

  .day:hover .tooltip {
    opacity: 1;
    visibility: visible;
  }
</style>
