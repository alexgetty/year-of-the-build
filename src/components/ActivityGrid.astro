---
/**
 * ActivityGrid — GitHub contribution calendar
 * Displays a grid of contribution squares with CSS-only hover tooltips
 * Data fetched at build time via GitHub GraphQL API
 *
 * Squares scale to fit container width. Tooltips have edge detection
 * to prevent clipping on left/right edges.
 */
import {
  fetchGitHubContributions,
  getContributionLevel,
  formatContributionDate,
  type ContributionDay,
} from '../lib/github';

interface Props {
  username: string;
}

const { username } = Astro.props;

// Fetch contribution data at build time
const data = await fetchGitHubContributions(username);
const weeks = data?.calendar.weeks ?? [];
const totalWeeks = weeks.length;

// Flatten all days for rendering
type DayWithLevel = ContributionDay & { level: 0 | 1 | 2 | 3 | 4 };

const allDays: DayWithLevel[][] = weeks.map((week) =>
  week.contributionDays.map((day) => ({
    ...day,
    level: getContributionLevel(day.contributionCount),
  }))
);

// Edge detection: first 6 weeks align tooltip left, last 6 align right
function getTooltipPosition(weekIndex: number, totalWeeks: number): 'left' | 'center' | 'right' {
  if (weekIndex < 6) return 'left';
  if (weekIndex >= totalWeeks - 6) return 'right';
  return 'center';
}
---

<div class="activity-container">
  <div class="activity-grid">
    {allDays.map((week, weekIndex) =>
      week.map((day) => (
        <div
          class="day"
          data-level={day.level}
          data-tooltip-pos={getTooltipPosition(weekIndex, totalWeeks)}
        >
          <span class="tooltip">
            {day.contributionCount === 0
              ? 'No contributions'
              : day.contributionCount === 1
                ? '1 contribution'
                : `${day.contributionCount} contributions`}
            <br />
            <span class="tooltip-date">{formatContributionDate(day.date)}</span>
          </span>
        </div>
      ))
    )}
  </div>
</div>

<style>
  .activity-container {
    background: var(--p-ink-50);
    border: 1px solid var(--p-ink-200);
    padding: 1px;
    overflow: visible;
  }

  .activity-grid {
    display: grid;
    grid-template-rows: repeat(7, 1fr);
    grid-auto-flow: column;
    grid-auto-columns: 1fr;
    gap: 1px;
    width: 100%;
    aspect-ratio: 53 / 7;
  }

  .day {
    border-radius: 1px;
    position: relative;
  }

  /* Contribution levels — Forest gradient */
  .day[data-level='0'] {
    background-color: var(--p-ink-200);
  }

  .day[data-level='1'] {
    background-color: var(--p-forest-200);
  }

  .day[data-level='2'] {
    background-color: var(--p-forest-400);
  }

  .day[data-level='3'] {
    background-color: var(--p-forest-600);
  }

  .day[data-level='4'] {
    background-color: var(--p-forest-800);
  }

  /* Tooltip base */
  .tooltip {
    position: absolute;
    bottom: calc(100% + 8px);
    background: var(--p-ink-950);
    color: var(--p-ink-50);
    font-size: var(--t-font-size-xs);
    line-height: 1.4;
    padding: 6px 10px;
    border-radius: var(--t-radius-md);
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.15s ease, visibility 0.15s ease;
    pointer-events: none;
    z-index: 100;
    text-align: center;
  }

  /* Tooltip arrow base */
  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    border: 5px solid transparent;
    border-top-color: var(--p-ink-950);
  }

  /* Center-aligned tooltip (default) */
  .day[data-tooltip-pos='center'] .tooltip {
    left: 50%;
    transform: translateX(-50%);
  }

  .day[data-tooltip-pos='center'] .tooltip::after {
    left: 50%;
    transform: translateX(-50%);
  }

  /* Left-aligned tooltip (for left edge) */
  .day[data-tooltip-pos='left'] .tooltip {
    left: 0;
    transform: none;
  }

  .day[data-tooltip-pos='left'] .tooltip::after {
    left: 6px;
    transform: none;
  }

  /* Right-aligned tooltip (for right edge) */
  .day[data-tooltip-pos='right'] .tooltip {
    right: 0;
    left: auto;
    transform: none;
  }

  .day[data-tooltip-pos='right'] .tooltip::after {
    right: 6px;
    left: auto;
    transform: none;
  }

  .tooltip-date {
    color: var(--p-ink-400);
  }

  .day:hover .tooltip {
    opacity: 1;
    visibility: visible;
  }
</style>
